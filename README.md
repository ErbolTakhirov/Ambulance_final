# 🚑 Ambulance Route - Система оптимальной маршрутизации скорой помощи

## 📋 Описание проекта

Интеллектуальная система построения оптимальных маршрутов для скорой помощи с учетом:
- ✅ **Реального трафика** на улицах Бишкека (данные из OpenStreetMap)
- ✅ **ML-предсказания** времени в пути с учетом пробок
- ✅ **Множественных маршрутов** с выбором оптимального
- ✅ **Визуализации трафика** в стиле 2GIS
- ✅ **Анимации движения** скорой помощи

## 🎯 Основные возможности

### 1. Построение маршрутов
- **OSRM** - основной сервис маршрутизации (3 сервера с failover)
- **GraphHopper** - резервный сервис (требует API ключ)
- **Fallback по улицам** - построение по реальным улицам при недоступности сервисов
- **Retry логика** - 2 попытки для каждого сервера с таймаутом 30 сек

### 2. ML-предсказание времени
- Учет текущего трафика на маршруте
- Время суток (час пик, ночь)
- Тип дороги (магистраль, второстепенная)
- Диапазон времени (мин-макс) с уровнем уверенности

### 3. Визуализация трафика
- Реальные улицы из OpenStreetMap
- 5 уровней загруженности (свободно → пробка)
- Цветовая индикация в стиле 2GIS
- Обновление каждые 60 секунд

## 🚀 Быстрый старт

### Шаг 1: Установка зависимостей

```bash
# Активировать виртуальное окружение
.\venv\Scripts\activate

# Установить зависимости (если еще не установлены)
pip install -r requirements.txt
```

### Шаг 2: Запуск сервера

```bash
python manage.py runserver
```

### Шаг 3: Открыть в браузере

```
http://127.0.0.1:8000/
```

## ⚙️ Настройка сервисов маршрутизации

### OSRM (работает из коробки)
Используются публичные серверы:
- `http://router.project-osrm.org`
- `https://routing.openstreetmap.de`
- `https://router.project-osrm.org`

**Проблема:** Публичные серверы могут быть перегружены или недоступны.

**Решение 1:** Увеличен timeout до 30 секунд и добавлена retry логика.

**Решение 2:** Добавлен fallback механизм с построением по улицам.

### GraphHopper (опционально, рекомендуется)

1. Зарегистрируйтесь на https://graphhopper.com/
2. Получите бесплатный API ключ (500 запросов/день)
3. Откройте `api/graphhopper_router.py`
4. Замените `YOUR_API_KEY_HERE` на ваш ключ:

```python
self.api_key = "ваш_ключ_здесь"
```

### Локальный OSRM сервер (для продакшена)

Для стабильной работы рекомендуется развернуть свой OSRM сервер:

```bash
# Docker способ (самый простой)
docker run -t -i -p 5000:5000 \
  -v "${PWD}:/data" \
  osrm/osrm-backend osrm-routed \
  --algorithm mld /data/kyrgyzstan-latest.osrm

# Затем в traffic_router.py добавьте:
self.osrm_servers = [
    "http://localhost:5000/route/v1/driving",
    # ... остальные серверы как fallback
]
```

## 📊 Архитектура системы

```
┌─────────────────────────────────────────────────────────┐
│                     Frontend (Leaflet)                   │
│  - Карта Бишкека                                        │
│  - Визуализация трафика                                 │
│  - Отображение маршрутов                                │
│  - Анимация скорой помощи                               │
└────────────────┬────────────────────────────────────────┘
                 │ API Requests
┌────────────────▼────────────────────────────────────────┐
│                  Django Backend (API)                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │  TrafficAwareRouter (traffic_router.py)          │  │
│  │  ├─ OSRM (3 сервера + retry)                     │  │
│  │  ├─ GraphHopper (резерв)                         │  │
│  │  └─ Fallback (по улицам)                         │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  ML Predictor (ml_predictor.py)                  │  │
│  │  - Предсказание времени в пути                   │  │
│  │  - Учет трафика и времени суток                  │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  OSM Loader (osm_loader.py)                      │  │
│  │  - Загрузка улиц из OpenStreetMap               │  │
│  │  - Кэширование на 24 часа                        │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Traffic Manager (traffic_manager.py)            │  │
│  │  - Генерация трафика для улиц                    │  │
│  │  - Учет времени суток и типа дороги              │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 🔧 Решение проблем

### Проблема: OSRM timeout

**Симптомы:**
```
OSRM Connection Error: Read timed out
Routing failed, trying alternatives
```

**Решения:**
1. ✅ **Уже реализовано:** Увеличен timeout до 30 сек, добавлена retry логика
2. ✅ **Уже реализовано:** Fallback построение по улицам
3. 🔧 **Рекомендуется:** Настроить GraphHopper API ключ
4. 🔧 **Для продакшена:** Развернуть локальный OSRM сервер

### Проблема: Маршрут строится по прямой

**Причина:** Все сервисы маршрутизации недоступны

**Решение:**
- Теперь fallback строит маршрут по ближайшим улицам
- Настройте GraphHopper для более надежной работы

### Проблема: Медленная загрузка трафика

**Причина:** Overpass API может быть медленным

**Решение:**
- Данные кэшируются на 24 часа
- При ошибке используются fallback данные
- Можно увеличить время кэширования в `osm_loader.py`

## 📈 Производительность

### Текущие метрики:
- **Улиц в Бишкеке:** ~500-1000 (основные дороги)
- **Время загрузки трафика:** 2-5 сек (первый раз), мгновенно (из кэша)
- **Время расчета маршрута:** 
  - OSRM: 1-30 сек (зависит от сервера)
  - GraphHopper: 1-3 сек
  - Fallback: <1 сек

### Оптимизации:
- ✅ Кэширование улиц OSM
- ✅ Retry логика с таймаутами
- ✅ Множественные серверы OSRM
- ✅ Fallback механизм

## 🎨 Использование

### 1. Выбор больницы
- Выберите больницу из списка (10 реальных больниц Бишкека)
- На карте появится синий маркер

### 2. Выбор пункта назначения
- Кликните на карту в нужной точке
- Появится красный маркер

### 3. Расчет маршрута
- Нажмите "Рассчитать маршрут"
- Система построит оптимальный маршрут с учетом трафика
- Отобразится информация:
  - Расстояние (км)
  - Время в пути (мин-макс)
  - Задержка из-за пробок
  - Средняя скорость
  - Точность ML предсказания

### 4. Анимация
- Скорая помощь (🚑) начнет движение по маршруту
- Можно наблюдать прогресс в реальном времени

## 🔑 API Endpoints

### GET `/api/hospitals/`
Список всех больниц

### GET `/api/traffic/streets_osm/`
Реальные улицы с трафиком

### POST `/api/routes/calculate/`
Расчет маршрута

**Request:**
```json
{
  "start_lat": 42.875144,
  "start_lng": 74.562028,
  "end_lat": 42.840278,
  "end_lng": 74.606667,
  "alternatives": 3
}
```

**Response:**
```json
{
  "success": true,
  "routes": [{
    "distance": 4900,
    "duration": 540,
    "traffic_aware_duration_minutes": 9.5,
    "min_time_minutes": 8.5,
    "max_time_minutes": 12.0,
    "confidence": 85.0,
    "average_speed": 35.2,
    "traffic_delay_minutes": 2.3,
    "quality": "good",
    "geometry": { ... }
  }]
}
```

## 📝 Технологии

### Backend:
- Django 4.2.7
- Django REST Framework
- Requests (HTTP клиент)
- NumPy (ML предсказания)

### Frontend:
- Leaflet.js (карты)
- Vanilla JavaScript
- CSS3 (градиенты, анимации)

### Сервисы:
- OpenStreetMap (карты)
- Overpass API (данные улиц)
- OSRM (маршрутизация)
- GraphHopper (резервная маршрутизация)

## 🤝 Вклад в проект

Проект создан для хакатона и демонстрирует:
- Интеграцию множественных сервисов маршрутизации
- ML-предсказание с учетом трафика
- Визуализацию данных в реальном времени
- Отказоустойчивую архитектуру

## 📄 Лицензия

Образовательный проект для хакатона.

## 👥 Команда

Разработано командой AmbulanceRoute для оптимизации работы скорой помощи в Бишкеке.

---

**Версия:** 2.0  
**Дата:** Декабрь 2025  
**Статус:** ✅ Полностью функционален
